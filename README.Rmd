---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# zarr

<!-- badges: start -->
[![R-CMD-check](https://github.com/R-CF/zarr/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/R-CF/zarr/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

`zarr` is a package to create and access Zarr stores using native R code. This package implements a native R driver for `zarr` stores. It is designed against the specification for Zarr core version 3.

## Basic usage

The easiest way to zarrify your data is simply to call `as_zarr()` on your R vector, matrix or array.
```{r as}
library(zarr)

x <- array(1:400, c(5, 20, 4))
z <- as_zarr(x)
z
```
This uses information from the array (data type, dimensions) in combination with default Zarr settings (chunk size, data layout, compression). `z` is an in-memory `zarr` object consisting of a single array, with the R object broken up into chunks (if the dimensions are substantially large enough to warrant that) and compressed.

If you prefer to persist your R object to file, provide a location where you want to store the data. It is recommended that the name of the store uses the ".zarr" extension.
```{r persist}
fn <- tempfile(fileext = ".zarr")
z <- as_zarr(x, fn)
z
```
Accessing data in a Zarr object is always through Zarr arrays identified by name. When using function `as_zarr()` you don't specify a name but the Zarr object can only hold a single array, which is located at the root `"/"` of the Zarr object.
```{r array}
# Get an array using list-like access on the Zarr object
arr <- z[["/"]]
arr

# Index the Zarr array like a regular R array
# Indexes are 1-based, as usual in R (Zarr specifies everything as 0-based)
arr[1:2, 11:16, 3]

# ... including omitting dimensions ...
arr[, 1:5,1:2]

# ... and logical selections
d <- arr$shape
arr[1, which(seq(d[2]) <= 10), ]
```
In this last example you will have noticed that the degenerate first dimension was dropped. As in regular R, you have to explicitly indicate it if you want to keep degenerate dimensions:
```{r degenerate}
arr[1, which(seq(d[2]) <= 10), , drop = FALSE]
```
You can also write to a Zarr array, but the process is a bit more complicated (due to a quirk in R):
```{r write}
arr$write(-99L, selection = list(2:3, 5:7, 1))
arr[, 1:10, 1]
```
Two things of interest here:

 1. The data in the Zarr array is of type "int32", the standard R integer. When writing data you should make sure that the object to be written is of the correct type, so using "-99L" here.
 2. The data is recycled (from a single value to 6 elements in the Zarr array) using normal R rules. Do note, however, that only single values are recycled and the "broadcasting" is per dimension of the Zarr array.
 
```{r, include = FALSE}
unlink(fn)
```
## Installation
You can install the development version of `zarr` from [GitHub](https://github.com/) with:
```
# install.packages("devtools")
devtools::install_github("R-CF/zarr")
```
## Development
This package is in the early phases of development and should not be used for production environments. Things may fail and you are advised to ensure that you have backups of all data that you put in a Zarr store with this package.

Like Zarr itself, this package is modular and allows for additional stores, codes, transformers and extensions to be added to this basic implementation. If you have specific needs, open an [issue on Github](https://github.com/R-CF/zarr/issues) or, better yet, fork the code and submit code suggestions via a pull request. Specific guidance for developers is being drafted.
