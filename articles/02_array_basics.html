<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2. Working with arrays • zarr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Working with arrays">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">zarr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01_zarr.html">1. Zarr for R</a></li>
    <li><a class="dropdown-item" href="../articles/02_array_basics.html">2. Working with arrays</a></li>
    <li><a class="dropdown-item" href="../articles/03_attributes.html">3. Working with attributes</a></li>
    <li><a class="dropdown-item" href="../articles/04_http.html">4. HTTP stores</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/R-CF/zarr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>2. Working with arrays</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/R-CF/zarr/blob/v0.2.0/vignettes/articles/02_array_basics.Rmd" class="external-link"><code>vignettes/articles/02_array_basics.Rmd</code></a></small>
      <div class="d-none name"><code>02_array_basics.Rmd</code></div>
    </div>

    
    
<p>If you are working with Zarr, you want to store your data in a
compact manner that is easy to use, with persistence between R sessions
and portable to other environments. In this article we’ll show you how
to create Zarr arrays, how to load data into them and how to read the
data back into your (future) R session.</p>
<blockquote>
<p>When we are referring to “arrays” we’ll be explicit about what we are
talking about: a “Zarr array” is a data structure in a “Zarr object”.
This is to avoid confusion with the “R array”. Note that a Zarr array
can store an R array but also a matrix or a vector.</p>
</blockquote>
<div class="section level2">
<h2 id="quick-start">Quick start<a class="anchor" aria-label="anchor" href="#quick-start"></a>
</h2>
<p>The easiest way to create a Zarr object is to simply “cast” your R
object to a Zarr object.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/R-CF/zarr" class="external-link">zarr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">500</span></span>
<span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_zarr.html">as_zarr</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">z</span></span>
<span><span class="co">#&gt; &lt;Zarr&gt;</span></span>
<span><span class="co">#&gt; Version   : 3 </span></span>
<span><span class="co">#&gt; Store     : memory store </span></span>
<span><span class="co">#&gt; Arrays    : 1 (single array store)</span></span></code></pre></div>
<p>This creates a Zarr array in memory from an R vector of integers with
a length of 500. The two vector properties <em>mode</em> and
<em>length</em> are used to define the Zarr array, in combination with
some default Zarr settings such as for the chunking and the
compression.</p>
<p>In general it is more useful to persist your data to a Zarr “store”.
The store is a directory on your local file system and you can put
multiple Zarr arrays in one Zarr store, using a directory hierarchy of
Zarr groups. These Zarr stores are identified by the presence of a
“zarr.json” file, one for each Zarr group and array, a JSON document
that defines what is contained in the directory. These Zarr stores can
be used to persist data between R sessions, for instance as an
alternative to “.Rdata” files.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10000</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">10</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a Zarr array from an R array, with a name for the array</span></span>
<span><span class="co"># and persisted to the local file system</span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".zarr"</span><span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_zarr.html">as_zarr</a></span><span class="op">(</span><span class="va">x</span>, name <span class="op">=</span> <span class="st">"top_array"</span>, location <span class="op">=</span> <span class="va">fn</span><span class="op">)</span></span>
<span><span class="va">z</span></span>
<span><span class="co">#&gt; &lt;Zarr&gt;</span></span>
<span><span class="co">#&gt; Version   : 3 </span></span>
<span><span class="co">#&gt; Store     : Local file system store </span></span>
<span><span class="co">#&gt; Location  : /tmp/Rtmpxv8oi2/file1e2862300e0b.zarr </span></span>
<span><span class="co">#&gt; Arrays    : 1 </span></span>
<span><span class="co">#&gt; Total size: 2.91 KB</span></span>
<span><span class="va">z</span><span class="op">$</span><span class="fu">hierarchy</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;Zarr hierarchy&gt; /tmp/Rtmpxv8oi2/file1e2862300e0b.zarr </span></span>
<span><span class="co">#&gt; ☰ / (root group)</span></span>
<span><span class="co">#&gt; └ ⌗ top_array</span></span></code></pre></div>
<p>If you have multiple R objects that you want to store in the Zarr
format, you can place them all in the same store. Adding an R object to
an existing store requires you to indicate the group in the Zarr object
where you want to store the R object.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Some R objects</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the root group from the Zarr object and put one R object there</span></span>
<span><span class="va">grp</span> <span class="op">&lt;-</span> <span class="va">z</span><span class="op">[[</span><span class="st">"/"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">arr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_zarr.html">as_zarr</a></span><span class="op">(</span><span class="va">v</span>, name <span class="op">=</span> <span class="st">"a_vector"</span>, location <span class="op">=</span> <span class="va">grp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make a sub-group in the Zarr object, for our Japanese developers</span></span>
<span><span class="co"># UTF-8 is allowed in group and array names</span></span>
<span><span class="va">grp</span> <span class="op">&lt;-</span> <span class="va">z</span><span class="op">$</span><span class="fu">add_group</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/"</span>, name <span class="op">=</span> <span class="st">"サブグループ"</span><span class="op">)</span>  <span class="co"># = subgroup</span></span>
<span><span class="va">arr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_zarr.html">as_zarr</a></span><span class="op">(</span><span class="va">w</span>, name <span class="op">=</span> <span class="st">"空の行列"</span>, location <span class="op">=</span> <span class="va">grp</span><span class="op">)</span>  <span class="co"># = empty matrix</span></span>
<span><span class="va">z</span><span class="op">$</span><span class="fu">hierarchy</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;Zarr hierarchy&gt; /tmp/Rtmpxv8oi2/file1e2862300e0b.zarr </span></span>
<span><span class="co">#&gt; ☰ / (root group)</span></span>
<span><span class="co">#&gt; ├ ⌗ top_array</span></span>
<span><span class="co">#&gt; ├ ⌗ a_vector</span></span>
<span><span class="co">#&gt; └ ☰ サブグループ</span></span>
<span><span class="co">#&gt;   └ ⌗ 空の行列</span></span></code></pre></div>
<p>Directories with Zarr arrays have data files with names like
<code>c.1.0.0</code>, usually compressed to save disk space. (The chunks
may also be stored in directory trees, like <code>c/1/0</code> with the
chunk in files like <code>0</code>, <code>1</code>, <code>2</code>,
…)</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">z</span><span class="op">$</span><span class="va">store</span><span class="op">$</span><span class="va">root</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "a_vector/c.0"                    "a_vector/c.1"                   </span></span>
<span><span class="co">#&gt;  [3] "a_vector/c.2"                    "a_vector/c.3"                   </span></span>
<span><span class="co">#&gt;  [5] "a_vector/c.4"                    "a_vector/zarr.json"             </span></span>
<span><span class="co">#&gt;  [7] "top_array/c.0.0.0"               "top_array/c.1.0.0"              </span></span>
<span><span class="co">#&gt;  [9] "top_array/c.2.0.0"               "top_array/c.3.0.0"              </span></span>
<span><span class="co">#&gt; [11] "top_array/c.4.0.0"               "top_array/zarr.json"            </span></span>
<span><span class="co">#&gt; [13] "zarr.json"                       "サブグループ/zarr.json"         </span></span>
<span><span class="co">#&gt; [15] "サブグループ/空の行列/zarr.json"</span></span>
<span><span class="va">z</span></span>
<span><span class="co">#&gt; &lt;Zarr&gt;</span></span>
<span><span class="co">#&gt; Version   : 3 </span></span>
<span><span class="co">#&gt; Store     : Local file system store </span></span>
<span><span class="co">#&gt; Location  : /tmp/Rtmpxv8oi2/file1e2862300e0b.zarr </span></span>
<span><span class="co">#&gt; Arrays    : 3 </span></span>
<span><span class="co">#&gt; Total size: 7.67 KB</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">fn</span><span class="op">)</span></span></code></pre></div>
<p>A couple of things to note:</p>
<ul>
<li>The total size that is printed to the console when inspecting a Zarr
object sums up the size of both types of files in the root directory and
any sub-directories. Note that the compression here is spectacular:
10,000 integers in the R array <code>x</code> take up 40,000 bytes,
vector <code>v</code> and matrix <code>w</code> another 4,120 bytes.
Inclusive of the non-compressed JSON files, the Zarr store takes up only
a small fraction of that.</li>
<li>By default, R objects are broken up into chunks of length 100 along
each dimension of the R object. Vector <code>v</code> thus has chunks
named <code>c.0</code>, <code>c.1</code>, <code>c.2</code>,
<code>c.3</code>, <code>c.4</code>. Array <code>x</code> has three
dimensions, so the names are like <code>c.0.0.0</code>. The indices for
the chunks names are 0-based, a requirement from the Zarr specification.
Note that our Japanese Zarr array <code>/サブグループ/空の行列</code>
does not have any data files at all: matrix <code>w</code> was created
with <code>data = NA</code> and chunks with only <code>NA</code> values
are not written to disk for added efficiency.</li>
</ul>
</div>
<div class="section level2">
<h2 id="creating-your-own-zarr-arrays">Creating your own Zarr arrays<a class="anchor" aria-label="anchor" href="#creating-your-own-zarr-arrays"></a>
</h2>
<p>You can define your own Zarr arrays with full control over the
parameters to be used. A special utility class,
<code>array_builder</code>, helps you construct a valid “zarr.json”
metadata document that you need when creating the Zarr array.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">arr_def</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_array.html">define_array</a></span><span class="op">(</span>data_type <span class="op">=</span> <span class="st">"int16"</span>, shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">240</span>, <span class="fl">310</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">arr_def</span></span>
<span><span class="co">#&gt; &lt;Zarr array metadata&gt; VALID </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "zarr_format": 3,</span></span>
<span><span class="co">#&gt;   "node_type": "array",</span></span>
<span><span class="co">#&gt;   "shape": [240, 310, 5],</span></span>
<span><span class="co">#&gt;   "data_type": "int16",</span></span>
<span><span class="co">#&gt;   "fill_value": -32767,</span></span>
<span><span class="co">#&gt;   "chunk_grid": {</span></span>
<span><span class="co">#&gt;     "name": "regular",</span></span>
<span><span class="co">#&gt;     "configuration": {</span></span>
<span><span class="co">#&gt;       "chunk_shape": [100, 100, 5]</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   },</span></span>
<span><span class="co">#&gt;   "codecs": {</span></span>
<span><span class="co">#&gt;     "transpose": {</span></span>
<span><span class="co">#&gt;       "name": "transpose",</span></span>
<span><span class="co">#&gt;       "configuration": {</span></span>
<span><span class="co">#&gt;         "order": [2, 1, 0]</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     },</span></span>
<span><span class="co">#&gt;     "bytes": {</span></span>
<span><span class="co">#&gt;       "name": "bytes",</span></span>
<span><span class="co">#&gt;       "configuration": {</span></span>
<span><span class="co">#&gt;         "endian": "little"</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     },</span></span>
<span><span class="co">#&gt;     "blosc": {</span></span>
<span><span class="co">#&gt;       "name": "blosc",</span></span>
<span><span class="co">#&gt;       "configuration": {</span></span>
<span><span class="co">#&gt;         "level": 6,</span></span>
<span><span class="co">#&gt;         "cname": "zstd",</span></span>
<span><span class="co">#&gt;         "clevel": 1,</span></span>
<span><span class="co">#&gt;         "shuffle": "shuffle",</span></span>
<span><span class="co">#&gt;         "typesize": 2,</span></span>
<span><span class="co">#&gt;         "blocksize": 0</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
<p>Ok, that is a lot of things all at once. Let’s walk through this
line-by-line</p>
<pre><code><span><span class="va">VALID</span></span></code></pre>
<p>On the top line we see that the document shown is a valid Zarr array
metadata document. You may also get <code>INCOMPLETE</code> if some
configuration part is not yet fully defined.</p>
<pre><code><span><span class="st">"zarr_format"</span><span class="op">:</span> <span class="fl">3</span></span></code></pre>
<p>This package is for Zarr version 3 and the <code>array_builder</code>
will only create metadata documents for version 3. You may persist your
data in a Zarr version 2 store but within this package metadata is
always shown in version 3 format.</p>
<pre><code><span><span class="st">"node_type"</span><span class="op">:</span> <span class="st">"array"</span></span></code></pre>
<p>The metadata document is for a Zarr array. The only other option is
<code>"group"</code>.</p>
<pre><code>"shape": [240, 310, 5]</code></pre>
<p>The shape specified in the call to <code><a href="../reference/define_array.html">define_array()</a></code>. A
shape can have any number of dimensions. The dimensions are specified in
the regular R order.</p>
<pre><code><span><span class="st">"data_type"</span><span class="op">:</span> <span class="st">"int16"</span></span></code></pre>
<p>Zarr supports a large number of data types while R only has a few.
Data types are automatically translated between the two environments.
The data type that you specify for the Zarr array is what will be used
for the storage of the data in Zarr; in R, this data type would come out
as an “integer”.</p>
<pre><code><span><span class="st">"fill_value"</span><span class="op">:</span> <span class="op">-</span><span class="fl">32767</span></span></code></pre>
<p>Every Zarr array has a <code>fill_value</code> for parts of the array
that have not yet been written or where there is no data. The equivalent
in R is <code>NA</code>. Every data type has a default
<code>fill_value</code> but you can also set your own. In R, you will
rarely see the <code>fill_value</code> as the data is automatically
transformed from <code>NA</code> in R to <code>fill_value</code> in Zarr
and <em>vice-versa</em>.</p>
<pre><code>"chunk_grid": {
    "name": "regular",
    "configuration": {
      "chunk_shape": [100, 100, 5]
    }
  }</code></pre>
<p>A Zarr array is stored in “chunked” format, where the array is cut up
into chunks along each dimension. The default setting is to have chunks
with a length of 100 along each dimension (or smaller if the Zarr array
is smaller, as is the case here). This results in chunks with a maximum
size of 8MB for numeric data, 4MB for integer data and 1MB for logical
data, before compression, for a 3D Zarr array with shape
<code>[100, 100, 100]</code>. You may set this to a set of values that
better aligns with your array size and your retrieval pattern.</p>
<pre><code><span><span class="st">"codecs"</span></span></code></pre>
<p>The codecs are a list of operations that are executed when writing a
Zarr array to a Zarr store (“encoding”) and in reverse order when
reading a Zarr array from a Zarr store into R (“decoding”). This is a
big and complicated one so we’ll look at the individual codecs.</p>
<div class="section level6">
<h6 id="transpose">“transpose”<a class="anchor" aria-label="anchor" href="#transpose"></a>
</h6>
<p>The first, optional, processing step is the “transpose” codec. This
is included by default with the indices of the array dimensions in
reverse order. Zarr comes out of the C/Python environment and matrices
and arrays are stored in row-major order. R, on the other hand, used
column-major order. To ensure portability while reducing processing
overhead this codec is included: if it is encountered with the dimension
indices in reverse order, it is a no-op in R. If you want maximum
portability of your Zarr store, including for use in C or Python with
Zarr readers that do not support the transpose codec then you can delete
this codec from the list. Do note, however, that this will increase
processing time when writing and reading Zarr arrays in R.</p>
</div>
<div class="section level6">
<h6 id="bytes">“bytes”<a class="anchor" aria-label="anchor" href="#bytes"></a>
</h6>
<p>The “bytes” codec is (effectively) mandatory. It takes an R object
and turns it into a byte stream with multi-byte data processed according
to a given byte ordering (or endianness). You very rarely, if ever, have
to worry about this codec.</p>
</div>
<div class="section level6">
<h6 id="blosc">“blosc”<a class="anchor" aria-label="anchor" href="#blosc"></a>
</h6>
<p>Most Zarr arrays are compressed when stored as that reduces required
file storage and network transmission time. The default compression used
in this package is “blosc”, which includes a number of compression
algorithms, here using “zstd”. The “level” argument can be set from 0
(no compression) to 9 (maximum compression), with higher values leading
to smaller chunk sizes but longer processing. The other arguments are
selected automatically and are best left to their default values. There
are several more compression libraries to choose from.</p>
</div>
<div class="section level3">
<h3 id="modifying-the-array-definition">Modifying the array definition<a class="anchor" aria-label="anchor" href="#modifying-the-array-definition"></a>
</h3>
<p>The <code>arr_def</code> variable is an instance of the
<code>array_builder</code> class. Using that class you can easily add of
modify parts of the array definition. As an example, you can set the
“chunking” of the array to different dimension, such as a “clean”
portion of each dimension to avoid having unused parts in the outer-most
chunks:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">arr_def</span><span class="op">$</span><span class="va">chunk_shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">120</span>, <span class="fl">31</span>, <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>Adding and deleting a codec is a bit more complicated because when
adding you have to specify the name of the codec but also provide a list
with the configuration parameters, and figure out where in the list of
codecs the new codec should be inserted; when deleting the remaining
codecs have to form a valid process. You should consult the online
documentation for the codec to find the right parameters. Once you have
those parameters organized in a list, adding a codec is easy. As an
example, let’s remove the <code>blosc</code> codec and insert the
<code>gzip</code> codec instead.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">arr_def</span><span class="op">$</span><span class="fu">remove_codec</span><span class="op">(</span>codec <span class="op">=</span> <span class="st">"blosc"</span><span class="op">)</span></span>
<span><span class="va">arr_def</span><span class="op">$</span><span class="fu">add_codec</span><span class="op">(</span>codec <span class="op">=</span> <span class="st">"gzip"</span>, configuration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required namespace: zlib</span></span>
<span><span class="va">arr_def</span></span>
<span><span class="co">#&gt; &lt;Zarr array metadata&gt; VALID </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "zarr_format": 3,</span></span>
<span><span class="co">#&gt;   "node_type": "array",</span></span>
<span><span class="co">#&gt;   "shape": [240, 310, 5],</span></span>
<span><span class="co">#&gt;   "data_type": "int16",</span></span>
<span><span class="co">#&gt;   "fill_value": -32767,</span></span>
<span><span class="co">#&gt;   "chunk_grid": {</span></span>
<span><span class="co">#&gt;     "name": "regular",</span></span>
<span><span class="co">#&gt;     "configuration": {</span></span>
<span><span class="co">#&gt;       "chunk_shape": [120, 31, 5]</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   },</span></span>
<span><span class="co">#&gt;   "codecs": {</span></span>
<span><span class="co">#&gt;     "transpose": {</span></span>
<span><span class="co">#&gt;       "name": "transpose",</span></span>
<span><span class="co">#&gt;       "configuration": {</span></span>
<span><span class="co">#&gt;         "order": [2, 1, 0]</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     },</span></span>
<span><span class="co">#&gt;     "bytes": {</span></span>
<span><span class="co">#&gt;       "name": "bytes",</span></span>
<span><span class="co">#&gt;       "configuration": {</span></span>
<span><span class="co">#&gt;         "endian": "little"</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     },</span></span>
<span><span class="co">#&gt;     "gzip": {</span></span>
<span><span class="co">#&gt;       "name": "gzip",</span></span>
<span><span class="co">#&gt;       "configuration": {</span></span>
<span><span class="co">#&gt;         "level": 5</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="creating-a-zarr-array">Creating a Zarr array<a class="anchor" aria-label="anchor" href="#creating-a-zarr-array"></a>
</h3>
<p>Once you are happy with the <code>arr_def</code> settings you can
create as many Zarr arrays with it as you need.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a Zarr object in memory</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_zarr.html">create_zarr</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a first array in the root group</span></span>
<span><span class="va">z</span><span class="op">$</span><span class="fu">add_array</span><span class="op">(</span><span class="st">"/"</span>, <span class="st">"first_array"</span>, <span class="va">arr_def</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;Zarr array&gt; first_array </span></span>
<span><span class="co">#&gt; Path      : /first_array </span></span>
<span><span class="co">#&gt; Data type : int16 </span></span>
<span><span class="co">#&gt; Shape     : 240 310 5 </span></span>
<span><span class="co">#&gt; Chunking  : 120 31 5</span></span>
<span></span>
<span><span class="co"># Re-use the array definition</span></span>
<span><span class="va">z</span><span class="op">$</span><span class="fu">add_array</span><span class="op">(</span><span class="st">"/"</span>, <span class="st">"another_array"</span>, <span class="va">arr_def</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;Zarr array&gt; another_array </span></span>
<span><span class="co">#&gt; Path      : /another_array </span></span>
<span><span class="co">#&gt; Data type : int16 </span></span>
<span><span class="co">#&gt; Shape     : 240 310 5 </span></span>
<span><span class="co">#&gt; Chunking  : 120 31 5</span></span>
<span></span>
<span><span class="va">z</span><span class="op">$</span><span class="fu">hierarchy</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;Zarr hierarchy&gt; </span></span>
<span><span class="co">#&gt; ☰ / (root group)</span></span>
<span><span class="co">#&gt; ├ ⌗ first_array</span></span>
<span><span class="co">#&gt; └ ⌗ another_array</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="reading-and-writing-zarr-arrays">Reading and writing Zarr arrays<a class="anchor" aria-label="anchor" href="#reading-and-writing-zarr-arrays"></a>
</h2>
<p>You can access the data in a Zarr object through its arrays. If you
do not specify a name when using function <code><a href="../reference/as_zarr.html">as_zarr()</a></code> the
Zarr object can only hold a single array, which is located at the root
<code>"/"</code> of the Zarr object. If you do specify a name, then the
array is located at the root of the Zarr store or in a group below
that.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">400</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">20</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".zarr"</span><span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_zarr.html">as_zarr</a></span><span class="op">(</span><span class="va">x</span>, location <span class="op">=</span> <span class="va">fn</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the array using list-like access on the Zarr object</span></span>
<span><span class="va">arr</span> <span class="op">&lt;-</span> <span class="va">z</span><span class="op">[[</span><span class="st">"/"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">arr</span></span>
<span><span class="co">#&gt; &lt;Zarr array&gt;  </span></span>
<span><span class="co">#&gt; Path      : / </span></span>
<span><span class="co">#&gt; Data type : int32 </span></span>
<span><span class="co">#&gt; Shape     : 5 20 4 </span></span>
<span><span class="co">#&gt; Chunking  : 5 20 4</span></span>
<span></span>
<span><span class="co"># Index the Zarr array like a regular R array</span></span>
<span><span class="co"># Indexes are 1-based, as usual in R (Zarr specifies everything as 0-based)</span></span>
<span><span class="va">arr</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">11</span><span class="op">:</span><span class="fl">16</span>, <span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6]</span></span>
<span><span class="co">#&gt; [1,]  251  256  261  266  271  276</span></span>
<span><span class="co">#&gt; [2,]  252  257  262  267  272  277</span></span>
<span></span>
<span><span class="co"># ... including omitting dimensions ...</span></span>
<span><span class="va">arr</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#&gt; , , 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5]</span></span>
<span><span class="co">#&gt; [1,]    1    6   11   16   21</span></span>
<span><span class="co">#&gt; [2,]    2    7   12   17   22</span></span>
<span><span class="co">#&gt; [3,]    3    8   13   18   23</span></span>
<span><span class="co">#&gt; [4,]    4    9   14   19   24</span></span>
<span><span class="co">#&gt; [5,]    5   10   15   20   25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; , , 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5]</span></span>
<span><span class="co">#&gt; [1,]  101  106  111  116  121</span></span>
<span><span class="co">#&gt; [2,]  102  107  112  117  122</span></span>
<span><span class="co">#&gt; [3,]  103  108  113  118  123</span></span>
<span><span class="co">#&gt; [4,]  104  109  114  119  124</span></span>
<span><span class="co">#&gt; [5,]  105  110  115  120  125</span></span>
<span></span>
<span><span class="co"># ... and logical selections</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">arr</span><span class="op">$</span><span class="va">shape</span></span>
<span><span class="va">arr</span><span class="op">[</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;       [,1] [,2] [,3] [,4]</span></span>
<span><span class="co">#&gt;  [1,]    1  101  201  301</span></span>
<span><span class="co">#&gt;  [2,]    6  106  206  306</span></span>
<span><span class="co">#&gt;  [3,]   11  111  211  311</span></span>
<span><span class="co">#&gt;  [4,]   16  116  216  316</span></span>
<span><span class="co">#&gt;  [5,]   21  121  221  321</span></span>
<span><span class="co">#&gt;  [6,]   26  126  226  326</span></span>
<span><span class="co">#&gt;  [7,]   31  131  231  331</span></span>
<span><span class="co">#&gt;  [8,]   36  136  236  336</span></span>
<span><span class="co">#&gt;  [9,]   41  141  241  341</span></span>
<span><span class="co">#&gt; [10,]   46  146  246  346</span></span>
<span></span>
<span><span class="co"># If you want to keep the degenerate first dimension, you have to explicitly </span></span>
<span><span class="co"># indicate that, just like with R arrays.</span></span>
<span><span class="va">arr</span><span class="op">[</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="co">#&gt; , , 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">#&gt; [1,]    1    6   11   16   21   26   31   36   41    46</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; , , 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">#&gt; [1,]  101  106  111  116  121  126  131  136  141   146</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; , , 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">#&gt; [1,]  201  206  211  216  221  226  231  236  241   246</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; , , 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">#&gt; [1,]  301  306  311  316  321  326  331  336  341   346</span></span></code></pre></div>
<p>You can also write to a Zarr array directly, for instance to write
smaller subsets of the Zarr array. The process is a bit more
complicated, however (due to a quirk in R):</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">arr</span><span class="op">$</span><span class="fu">write</span><span class="op">(</span><span class="cn">NA_integer_</span>, selection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">arr</span><span class="op">$</span><span class="fu">write</span><span class="op">(</span><span class="op">-</span><span class="fl">99L</span>, selection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">5</span><span class="op">:</span><span class="fl">7</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">arr</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">#&gt; [1,]    1    6   11   16   21   NA   31   36   41    46</span></span>
<span><span class="co">#&gt; [2,]    2    7   12   17  -99  -99  -99   37   42    47</span></span>
<span><span class="co">#&gt; [3,]    3    8   13   18  -99  -99  -99   38   43    48</span></span>
<span><span class="co">#&gt; [4,]    4    9   14   19   24   NA   34   39   44    49</span></span>
<span><span class="co">#&gt; [5,]    5   10   15   20   25   NA   35   40   45    50</span></span></code></pre></div>
<p>A few things of interest here:</p>
<ol style="list-style-type: decimal">
<li>The <code>zarr</code> package uses the <code>R6</code> framework.
That means that you access fields of the objects just like you would
with list elements. The Zarr array has multiple properties that you can
access using this syntax, here retrieving the shape of the Zarr array as
an integer vector with <code>d &lt;- arr$shape</code>.</li>
<li>The data in the Zarr array is of type “int32”, the standard R
integer. When writing data you should make sure that the object to be
written is of the correct type, so using <code>-99L</code> and
<code>NA_integer_</code> here. Numeric data is stored by default as
“float64”, logical data as “int8”.</li>
<li>The data is recycled (from a single value to 6 elements in the Zarr
array) using normal R rules. Do note, however, that only single values
are recycled and the broadcasting is per dimension of the Zarr
array.</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Patrick Van Laake.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
